create database test_apply dbcompatibility='D';
\c test_apply
create extension shark;
-- cross and outer apply
create table departments(department_name varchar(50), department_id int);
create table employees(employee_id int, department_id int, last_name varchar(50));
insert into departments values ('Marketing', 1);
insert into departments values ('Public Relations', 2);
insert into departments values ('Operations', 3);
insert into departments values ('Develop', 4);
insert into departments values ('Research', 5);
insert into departments values ('CEO', 6);
insert into departments values ('CFO', 7);
insert into employees values(1, 1, 'zhangsan1');
insert into employees values(2, 1, 'zhangsan2');
insert into employees values(3, 1, 'zhangsan3');
insert into employees values(4, 1, 'zhangsan4');
insert into employees values(5, 2, 'lisi1');
insert into employees values(6, 2, 'lisi2');
insert into employees values(7, 2, 'lisi3');
insert into employees values(8, 2, 'lisi4');
insert into employees values(9,  3, 'wangwu1');
insert into employees values(10, 3, 'wangwu2');
insert into employees values(11, 3, 'wangwu3');
insert into employees values(12, 3, 'wangwu4');
insert into employees values(13, 4, 'heliu1');
insert into employees values(14, 4, 'heliu2');
insert into employees values(15, 4, 'heliu3');
insert into employees values(16, 4, 'heliu4');
insert into employees values(17, 5, 'chenqi1');
insert into employees values(18, 5, 'chenqi2');
insert into employees values(19, 5, 'chenqi3');
insert into employees values(20, 5, 'chenqi4');
create function fn_salar (departmentid int) returns table (employee_id int, department_id int, last_name varchar) language sql as 'select employee_id, department_id, concat(last_name,last_name) as last_name2 from employees WHERE department_id = departmentid';
select* from departments d cross apply employees e where e.department_id = d.department_id;
 department_name  | department_id | employee_id | department_id | last_name 
------------------+---------------+-------------+---------------+-----------
 Marketing        |             1 |           4 |             1 | zhangsan4
 Marketing        |             1 |           3 |             1 | zhangsan3
 Marketing        |             1 |           2 |             1 | zhangsan2
 Marketing        |             1 |           1 |             1 | zhangsan1
 Public Relations |             2 |           8 |             2 | lisi4
 Public Relations |             2 |           7 |             2 | lisi3
 Public Relations |             2 |           6 |             2 | lisi2
 Public Relations |             2 |           5 |             2 | lisi1
 Operations       |             3 |          12 |             3 | wangwu4
 Operations       |             3 |          11 |             3 | wangwu3
 Operations       |             3 |          10 |             3 | wangwu2
 Operations       |             3 |           9 |             3 | wangwu1
 Develop          |             4 |          16 |             4 | heliu4
 Develop          |             4 |          15 |             4 | heliu3
 Develop          |             4 |          14 |             4 | heliu2
 Develop          |             4 |          13 |             4 | heliu1
 Research         |             5 |          20 |             5 | chenqi4
 Research         |             5 |          19 |             5 | chenqi3
 Research         |             5 |          18 |             5 | chenqi2
 Research         |             5 |          17 |             5 | chenqi1
(20 rows)

select* from departments d cross apply (select d.department_id from employees x) e where e.department_id = d.department_id;
 department_name  | department_id | department_id 
------------------+---------------+---------------
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
(140 rows)

SELECT * FROM employees AS e CROSS APPLY fn_Salar(e.department_id) AS f;
 employee_id | department_id | last_name | employee_id | department_id |     last_name      
-------------+---------------+-----------+-------------+---------------+--------------------
           1 |             1 | zhangsan1 |           1 |             1 | zhangsan1zhangsan1
           1 |             1 | zhangsan1 |           2 |             1 | zhangsan2zhangsan2
           1 |             1 | zhangsan1 |           3 |             1 | zhangsan3zhangsan3
           1 |             1 | zhangsan1 |           4 |             1 | zhangsan4zhangsan4
           2 |             1 | zhangsan2 |           1 |             1 | zhangsan1zhangsan1
           2 |             1 | zhangsan2 |           2 |             1 | zhangsan2zhangsan2
           2 |             1 | zhangsan2 |           3 |             1 | zhangsan3zhangsan3
           2 |             1 | zhangsan2 |           4 |             1 | zhangsan4zhangsan4
           3 |             1 | zhangsan3 |           1 |             1 | zhangsan1zhangsan1
           3 |             1 | zhangsan3 |           2 |             1 | zhangsan2zhangsan2
           3 |             1 | zhangsan3 |           3 |             1 | zhangsan3zhangsan3
           3 |             1 | zhangsan3 |           4 |             1 | zhangsan4zhangsan4
           4 |             1 | zhangsan4 |           1 |             1 | zhangsan1zhangsan1
           4 |             1 | zhangsan4 |           2 |             1 | zhangsan2zhangsan2
           4 |             1 | zhangsan4 |           3 |             1 | zhangsan3zhangsan3
           4 |             1 | zhangsan4 |           4 |             1 | zhangsan4zhangsan4
           5 |             2 | lisi1     |           5 |             2 | lisi1lisi1
           5 |             2 | lisi1     |           6 |             2 | lisi2lisi2
           5 |             2 | lisi1     |           7 |             2 | lisi3lisi3
           5 |             2 | lisi1     |           8 |             2 | lisi4lisi4
           6 |             2 | lisi2     |           5 |             2 | lisi1lisi1
           6 |             2 | lisi2     |           6 |             2 | lisi2lisi2
           6 |             2 | lisi2     |           7 |             2 | lisi3lisi3
           6 |             2 | lisi2     |           8 |             2 | lisi4lisi4
           7 |             2 | lisi3     |           5 |             2 | lisi1lisi1
           7 |             2 | lisi3     |           6 |             2 | lisi2lisi2
           7 |             2 | lisi3     |           7 |             2 | lisi3lisi3
           7 |             2 | lisi3     |           8 |             2 | lisi4lisi4
           8 |             2 | lisi4     |           5 |             2 | lisi1lisi1
           8 |             2 | lisi4     |           6 |             2 | lisi2lisi2
           8 |             2 | lisi4     |           7 |             2 | lisi3lisi3
           8 |             2 | lisi4     |           8 |             2 | lisi4lisi4
           9 |             3 | wangwu1   |           9 |             3 | wangwu1wangwu1
           9 |             3 | wangwu1   |          10 |             3 | wangwu2wangwu2
           9 |             3 | wangwu1   |          11 |             3 | wangwu3wangwu3
           9 |             3 | wangwu1   |          12 |             3 | wangwu4wangwu4
          10 |             3 | wangwu2   |           9 |             3 | wangwu1wangwu1
          10 |             3 | wangwu2   |          10 |             3 | wangwu2wangwu2
          10 |             3 | wangwu2   |          11 |             3 | wangwu3wangwu3
          10 |             3 | wangwu2   |          12 |             3 | wangwu4wangwu4
          11 |             3 | wangwu3   |           9 |             3 | wangwu1wangwu1
          11 |             3 | wangwu3   |          10 |             3 | wangwu2wangwu2
          11 |             3 | wangwu3   |          11 |             3 | wangwu3wangwu3
          11 |             3 | wangwu3   |          12 |             3 | wangwu4wangwu4
          12 |             3 | wangwu4   |           9 |             3 | wangwu1wangwu1
          12 |             3 | wangwu4   |          10 |             3 | wangwu2wangwu2
          12 |             3 | wangwu4   |          11 |             3 | wangwu3wangwu3
          12 |             3 | wangwu4   |          12 |             3 | wangwu4wangwu4
          13 |             4 | heliu1    |          13 |             4 | heliu1heliu1
          13 |             4 | heliu1    |          14 |             4 | heliu2heliu2
          13 |             4 | heliu1    |          15 |             4 | heliu3heliu3
          13 |             4 | heliu1    |          16 |             4 | heliu4heliu4
          14 |             4 | heliu2    |          13 |             4 | heliu1heliu1
          14 |             4 | heliu2    |          14 |             4 | heliu2heliu2
          14 |             4 | heliu2    |          15 |             4 | heliu3heliu3
          14 |             4 | heliu2    |          16 |             4 | heliu4heliu4
          15 |             4 | heliu3    |          13 |             4 | heliu1heliu1
          15 |             4 | heliu3    |          14 |             4 | heliu2heliu2
          15 |             4 | heliu3    |          15 |             4 | heliu3heliu3
          15 |             4 | heliu3    |          16 |             4 | heliu4heliu4
          16 |             4 | heliu4    |          13 |             4 | heliu1heliu1
          16 |             4 | heliu4    |          14 |             4 | heliu2heliu2
          16 |             4 | heliu4    |          15 |             4 | heliu3heliu3
          16 |             4 | heliu4    |          16 |             4 | heliu4heliu4
          17 |             5 | chenqi1   |          17 |             5 | chenqi1chenqi1
          17 |             5 | chenqi1   |          18 |             5 | chenqi2chenqi2
          17 |             5 | chenqi1   |          19 |             5 | chenqi3chenqi3
          17 |             5 | chenqi1   |          20 |             5 | chenqi4chenqi4
          18 |             5 | chenqi2   |          17 |             5 | chenqi1chenqi1
          18 |             5 | chenqi2   |          18 |             5 | chenqi2chenqi2
          18 |             5 | chenqi2   |          19 |             5 | chenqi3chenqi3
          18 |             5 | chenqi2   |          20 |             5 | chenqi4chenqi4
          19 |             5 | chenqi3   |          17 |             5 | chenqi1chenqi1
          19 |             5 | chenqi3   |          18 |             5 | chenqi2chenqi2
          19 |             5 | chenqi3   |          19 |             5 | chenqi3chenqi3
          19 |             5 | chenqi3   |          20 |             5 | chenqi4chenqi4
          20 |             5 | chenqi4   |          17 |             5 | chenqi1chenqi1
          20 |             5 | chenqi4   |          18 |             5 | chenqi2chenqi2
          20 |             5 | chenqi4   |          19 |             5 | chenqi3chenqi3
          20 |             5 | chenqi4   |          20 |             5 | chenqi4chenqi4
(80 rows)

 
SELECT d.department_name, v.employee_id, v.last_name
  FROM departments d CROSS APPLY (SELECT * FROM employees e WHERE e.department_id = d.department_id) v
  WHERE d.department_name IN ('Marketing', 'Operations', 'Public Relations')
  ORDER BY d.department_name, v.employee_id;
 department_name  | employee_id | last_name 
------------------+-------------+-----------
 Marketing        |           1 | zhangsan1
 Marketing        |           2 | zhangsan2
 Marketing        |           3 | zhangsan3
 Marketing        |           4 | zhangsan4
 Operations       |           9 | wangwu1
 Operations       |          10 | wangwu2
 Operations       |          11 | wangwu3
 Operations       |          12 | wangwu4
 Public Relations |           5 | lisi1
 Public Relations |           6 | lisi2
 Public Relations |           7 | lisi3
 Public Relations |           8 | lisi4
(12 rows)

  
select* from departments d outer apply employees e where e.department_id = d.department_id;
 department_name  | department_id | employee_id | department_id | last_name 
------------------+---------------+-------------+---------------+-----------
 Marketing        |             1 |           4 |             1 | zhangsan4
 Marketing        |             1 |           3 |             1 | zhangsan3
 Marketing        |             1 |           2 |             1 | zhangsan2
 Marketing        |             1 |           1 |             1 | zhangsan1
 Public Relations |             2 |           8 |             2 | lisi4
 Public Relations |             2 |           7 |             2 | lisi3
 Public Relations |             2 |           6 |             2 | lisi2
 Public Relations |             2 |           5 |             2 | lisi1
 Operations       |             3 |          12 |             3 | wangwu4
 Operations       |             3 |          11 |             3 | wangwu3
 Operations       |             3 |          10 |             3 | wangwu2
 Operations       |             3 |           9 |             3 | wangwu1
 Develop          |             4 |          16 |             4 | heliu4
 Develop          |             4 |          15 |             4 | heliu3
 Develop          |             4 |          14 |             4 | heliu2
 Develop          |             4 |          13 |             4 | heliu1
 Research         |             5 |          20 |             5 | chenqi4
 Research         |             5 |          19 |             5 | chenqi3
 Research         |             5 |          18 |             5 | chenqi2
 Research         |             5 |          17 |             5 | chenqi1
(20 rows)

select* from departments d cross apply (select d.department_id from employees x) e where e.department_id = d.department_id;
 department_name  | department_id | department_id 
------------------+---------------+---------------
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Marketing        |             1 |             1
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Public Relations |             2 |             2
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Operations       |             3 |             3
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Develop          |             4 |             4
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 Research         |             5 |             5
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CEO              |             6 |             6
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
 CFO              |             7 |             7
(140 rows)

SELECT * FROM employees AS e outer APPLY fn_Salar(e.department_id) AS f;
 employee_id | department_id | last_name | employee_id | department_id |     last_name      
-------------+---------------+-----------+-------------+---------------+--------------------
           1 |             1 | zhangsan1 |           1 |             1 | zhangsan1zhangsan1
           1 |             1 | zhangsan1 |           2 |             1 | zhangsan2zhangsan2
           1 |             1 | zhangsan1 |           3 |             1 | zhangsan3zhangsan3
           1 |             1 | zhangsan1 |           4 |             1 | zhangsan4zhangsan4
           2 |             1 | zhangsan2 |           1 |             1 | zhangsan1zhangsan1
           2 |             1 | zhangsan2 |           2 |             1 | zhangsan2zhangsan2
           2 |             1 | zhangsan2 |           3 |             1 | zhangsan3zhangsan3
           2 |             1 | zhangsan2 |           4 |             1 | zhangsan4zhangsan4
           3 |             1 | zhangsan3 |           1 |             1 | zhangsan1zhangsan1
           3 |             1 | zhangsan3 |           2 |             1 | zhangsan2zhangsan2
           3 |             1 | zhangsan3 |           3 |             1 | zhangsan3zhangsan3
           3 |             1 | zhangsan3 |           4 |             1 | zhangsan4zhangsan4
           4 |             1 | zhangsan4 |           1 |             1 | zhangsan1zhangsan1
           4 |             1 | zhangsan4 |           2 |             1 | zhangsan2zhangsan2
           4 |             1 | zhangsan4 |           3 |             1 | zhangsan3zhangsan3
           4 |             1 | zhangsan4 |           4 |             1 | zhangsan4zhangsan4
           5 |             2 | lisi1     |           5 |             2 | lisi1lisi1
           5 |             2 | lisi1     |           6 |             2 | lisi2lisi2
           5 |             2 | lisi1     |           7 |             2 | lisi3lisi3
           5 |             2 | lisi1     |           8 |             2 | lisi4lisi4
           6 |             2 | lisi2     |           5 |             2 | lisi1lisi1
           6 |             2 | lisi2     |           6 |             2 | lisi2lisi2
           6 |             2 | lisi2     |           7 |             2 | lisi3lisi3
           6 |             2 | lisi2     |           8 |             2 | lisi4lisi4
           7 |             2 | lisi3     |           5 |             2 | lisi1lisi1
           7 |             2 | lisi3     |           6 |             2 | lisi2lisi2
           7 |             2 | lisi3     |           7 |             2 | lisi3lisi3
           7 |             2 | lisi3     |           8 |             2 | lisi4lisi4
           8 |             2 | lisi4     |           5 |             2 | lisi1lisi1
           8 |             2 | lisi4     |           6 |             2 | lisi2lisi2
           8 |             2 | lisi4     |           7 |             2 | lisi3lisi3
           8 |             2 | lisi4     |           8 |             2 | lisi4lisi4
           9 |             3 | wangwu1   |           9 |             3 | wangwu1wangwu1
           9 |             3 | wangwu1   |          10 |             3 | wangwu2wangwu2
           9 |             3 | wangwu1   |          11 |             3 | wangwu3wangwu3
           9 |             3 | wangwu1   |          12 |             3 | wangwu4wangwu4
          10 |             3 | wangwu2   |           9 |             3 | wangwu1wangwu1
          10 |             3 | wangwu2   |          10 |             3 | wangwu2wangwu2
          10 |             3 | wangwu2   |          11 |             3 | wangwu3wangwu3
          10 |             3 | wangwu2   |          12 |             3 | wangwu4wangwu4
          11 |             3 | wangwu3   |           9 |             3 | wangwu1wangwu1
          11 |             3 | wangwu3   |          10 |             3 | wangwu2wangwu2
          11 |             3 | wangwu3   |          11 |             3 | wangwu3wangwu3
          11 |             3 | wangwu3   |          12 |             3 | wangwu4wangwu4
          12 |             3 | wangwu4   |           9 |             3 | wangwu1wangwu1
          12 |             3 | wangwu4   |          10 |             3 | wangwu2wangwu2
          12 |             3 | wangwu4   |          11 |             3 | wangwu3wangwu3
          12 |             3 | wangwu4   |          12 |             3 | wangwu4wangwu4
          13 |             4 | heliu1    |          13 |             4 | heliu1heliu1
          13 |             4 | heliu1    |          14 |             4 | heliu2heliu2
          13 |             4 | heliu1    |          15 |             4 | heliu3heliu3
          13 |             4 | heliu1    |          16 |             4 | heliu4heliu4
          14 |             4 | heliu2    |          13 |             4 | heliu1heliu1
          14 |             4 | heliu2    |          14 |             4 | heliu2heliu2
          14 |             4 | heliu2    |          15 |             4 | heliu3heliu3
          14 |             4 | heliu2    |          16 |             4 | heliu4heliu4
          15 |             4 | heliu3    |          13 |             4 | heliu1heliu1
          15 |             4 | heliu3    |          14 |             4 | heliu2heliu2
          15 |             4 | heliu3    |          15 |             4 | heliu3heliu3
          15 |             4 | heliu3    |          16 |             4 | heliu4heliu4
          16 |             4 | heliu4    |          13 |             4 | heliu1heliu1
          16 |             4 | heliu4    |          14 |             4 | heliu2heliu2
          16 |             4 | heliu4    |          15 |             4 | heliu3heliu3
          16 |             4 | heliu4    |          16 |             4 | heliu4heliu4
          17 |             5 | chenqi1   |          17 |             5 | chenqi1chenqi1
          17 |             5 | chenqi1   |          18 |             5 | chenqi2chenqi2
          17 |             5 | chenqi1   |          19 |             5 | chenqi3chenqi3
          17 |             5 | chenqi1   |          20 |             5 | chenqi4chenqi4
          18 |             5 | chenqi2   |          17 |             5 | chenqi1chenqi1
          18 |             5 | chenqi2   |          18 |             5 | chenqi2chenqi2
          18 |             5 | chenqi2   |          19 |             5 | chenqi3chenqi3
          18 |             5 | chenqi2   |          20 |             5 | chenqi4chenqi4
          19 |             5 | chenqi3   |          17 |             5 | chenqi1chenqi1
          19 |             5 | chenqi3   |          18 |             5 | chenqi2chenqi2
          19 |             5 | chenqi3   |          19 |             5 | chenqi3chenqi3
          19 |             5 | chenqi3   |          20 |             5 | chenqi4chenqi4
          20 |             5 | chenqi4   |          17 |             5 | chenqi1chenqi1
          20 |             5 | chenqi4   |          18 |             5 | chenqi2chenqi2
          20 |             5 | chenqi4   |          19 |             5 | chenqi3chenqi3
          20 |             5 | chenqi4   |          20 |             5 | chenqi4chenqi4
(80 rows)

SELECT d.department_name, v.employee_id, v.last_name
  FROM departments d outer APPLY (SELECT * FROM employees e WHERE e.department_id = d.department_id) v
  WHERE d.department_name IN ('Marketing', 'Operations', 'Public Relations')
  ORDER BY d.department_name, v.employee_id;
 department_name  | employee_id | last_name 
------------------+-------------+-----------
 Marketing        |           1 | zhangsan1
 Marketing        |           2 | zhangsan2
 Marketing        |           3 | zhangsan3
 Marketing        |           4 | zhangsan4
 Operations       |           9 | wangwu1
 Operations       |          10 | wangwu2
 Operations       |          11 | wangwu3
 Operations       |          12 | wangwu4
 Public Relations |           5 | lisi1
 Public Relations |           6 | lisi2
 Public Relations |           7 | lisi3
 Public Relations |           8 | lisi4
(12 rows)

create view v1 as SELECT d.department_name, v.employee_id, v.last_name
  FROM departments d CROSS APPLY (SELECT * FROM employees e WHERE e.department_id = d.department_id) v
  WHERE d.department_name IN ('Marketing', 'Operations', 'Public Relations')
  ORDER BY d.department_name, v.employee_id;
create view v2 as SELECT d.department_name, v.employee_id, v.last_name
  FROM departments d outer APPLY (SELECT * FROM employees e WHERE e.department_id = d.department_id) v
  WHERE d.department_name IN ('Marketing', 'Operations', 'Public Relations')
  ORDER BY d.department_name, v.employee_id;
select * from v1;
 department_name  | employee_id | last_name 
------------------+-------------+-----------
 Marketing        |           1 | zhangsan1
 Marketing        |           2 | zhangsan2
 Marketing        |           3 | zhangsan3
 Marketing        |           4 | zhangsan4
 Operations       |           9 | wangwu1
 Operations       |          10 | wangwu2
 Operations       |          11 | wangwu3
 Operations       |          12 | wangwu4
 Public Relations |           5 | lisi1
 Public Relations |           6 | lisi2
 Public Relations |           7 | lisi3
 Public Relations |           8 | lisi4
(12 rows)

select * from v2;
 department_name  | employee_id | last_name 
------------------+-------------+-----------
 Marketing        |           1 | zhangsan1
 Marketing        |           2 | zhangsan2
 Marketing        |           3 | zhangsan3
 Marketing        |           4 | zhangsan4
 Operations       |           9 | wangwu1
 Operations       |          10 | wangwu2
 Operations       |          11 | wangwu3
 Operations       |          12 | wangwu4
 Public Relations |           5 | lisi1
 Public Relations |           6 | lisi2
 Public Relations |           7 | lisi3
 Public Relations |           8 | lisi4
(12 rows)

CREATE TABLE tt1 AS
SELECT d.department_name, v.employee_id, v.last_name
FROM departments d
CROSS APPLY (SELECT * FROM employees e WHERE e.department_id = d.department_id) v
WHERE d.department_name IN ('Marketing', 'Operations', 'Public Relations')
ORDER BY d.department_name, v.employee_id;
CREATE TABLE tt2 AS
SELECT d.department_name, v.employee_id, v.last_name
FROM departments d
OUTER APPLY (SELECT * FROM employees e WHERE e.department_id = d.department_id) v
WHERE d.department_name IN ('Marketing', 'Operations', 'Public Relations')
ORDER BY d.department_name, v.employee_id;
select * from tt1;
 department_name  | employee_id | last_name 
------------------+-------------+-----------
 Marketing        |           1 | zhangsan1
 Marketing        |           2 | zhangsan2
 Marketing        |           3 | zhangsan3
 Marketing        |           4 | zhangsan4
 Operations       |           9 | wangwu1
 Operations       |          10 | wangwu2
 Operations       |          11 | wangwu3
 Operations       |          12 | wangwu4
 Public Relations |           5 | lisi1
 Public Relations |           6 | lisi2
 Public Relations |           7 | lisi3
 Public Relations |           8 | lisi4
(12 rows)

select * from tt2;
 department_name  | employee_id | last_name 
------------------+-------------+-----------
 Marketing        |           1 | zhangsan1
 Marketing        |           2 | zhangsan2
 Marketing        |           3 | zhangsan3
 Marketing        |           4 | zhangsan4
 Operations       |           9 | wangwu1
 Operations       |          10 | wangwu2
 Operations       |          11 | wangwu3
 Operations       |          12 | wangwu4
 Public Relations |           5 | lisi1
 Public Relations |           6 | lisi2
 Public Relations |           7 | lisi3
 Public Relations |           8 | lisi4
(12 rows)

create or replace procedure test_cursor_1 
as 
    company_name    varchar(100);
    last_name_name    varchar(100);
	type ref_cur_type is ref cursor;
    my_cur ref_cur_type;
    cursor c1 is SELECT e.last_name, CURSOR(SELECT d.department_name FROM departments d CROSS APPLY (SELECT * FROM employees e WHERE e.department_id = d.department_id) v WHERE d.department_name IN ('Marketing', 'Operations', 'Public Relations') ORDER BY d.department_name, v.employee_id) abc FROM employees e;
begin 
    OPEN c1;
    loop
        fetch c1 into company_name, my_cur;
        exit when c1%notfound;
	    raise notice 'company_name : %  %',company_name, my_cur;
	    loop
	        fetch my_cur into last_name_name;
            exit when my_cur%notfound;
            raise notice '     last_name_name : %',last_name_name;
	    end loop;
    end loop; 
end;
/
drop procedure test_cursor_1;
create or replace procedure test_cursor_2 
as 
    company_name    varchar(100);
    last_name_name    varchar(100);
	type ref_cur_type is ref cursor;
    my_cur ref_cur_type;
    cursor c1 is SELECT e.last_name, CURSOR(SELECT d.department_name FROM departments d outer APPLY (SELECT * FROM employees e WHERE e.department_id = d.department_id) v WHERE d.department_name IN ('Marketing', 'Operations', 'Public Relations') ORDER BY d.department_name, v.employee_id) abc FROM employees e;
begin 
    OPEN c1;
    loop
        fetch c1 into company_name, my_cur;
        exit when c1%notfound;
	    raise notice 'company_name : %  %',company_name, my_cur;
	    loop
	        fetch my_cur into last_name_name;
            exit when my_cur%notfound;
            raise notice '     last_name_name : %',last_name_name;
	    end loop;
    end loop; 
end;
/
drop procedure test_cursor_2;
drop view v1;
drop view v2;
drop table departments;
drop table employees;
\c postgres
drop database test_apply;
